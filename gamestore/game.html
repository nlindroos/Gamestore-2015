<!DOCTYPE html>
<html>
    <head>
        <title>Adventures of Save Button</title>
        <meta charset="utf-8">
        <style>
        body {
            background-color : MidnightBlue;
            overflow : hidden;
            font-family : "Lucida Console", Monaco, monospace;
            padding : 0px;
            margin : 0px;
        }
        #score_panel {
            width : 100%;
            position : fixed;
            height : 14vw;
        }
        .top_button {
            background-color : LightGray;
            font-size : 3vw;
            width : 33.3%;
            height : 4vw;
            margin: 0px;
            padding : 0px;
            display : block;
            float : left;
        }
        #info_text, #status_text {
            width : 100%;
            font-size: 3vw;
            height: 4vw;
            color : LightSkyBlue;
            background-color : LightSlateGray;
            white-space: nowrap;
            overflow: hidden;  
            text-overflow: ellipsis;
        }
        #game_area {
            background-color : black;
            width : 100%;
            min-width : 100%;
            height : 70vh;
            min-height : 70vh;
            position : fixed;
            top : 15vw;
        }
        #game_area div {
            position : absolute;
        }
        #save_button {
            width : 6%;
            height : 6%;
            padding : 0px;
            margin : 0px;
        }
        .obstacle {
            width : 1%;
            height : 1%;
            background-color : white;
        }
        #warning {
            width : 2vw;
            height : 2vh;
            background-color : black;
            border : 1px solid red;
        }
        .bonus {
            width : 3vw;
            height : 3vw;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
        }
        #healthpack {
            background-image : url(https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Flag_of_the_Red_Cross.svg/900px-Flag_of_the_Red_Cross.svg.png);
        }
        #ammopack {
            background-image : url(https://upload.wikimedia.org/wikipedia/commons/c/c2/Icon_vojn.png);
        }
        </style>
    </head>
    <body>
        <div id="score_panel">
            <div id="load_button" class="top_button">Load Game (Q)</div>
            <div id="pause_button" class="top_button">Pause Game (W)</div>
            <div id="newgame_button" class="top_button">New Game (E)</div>
            <div id="status_text">
                <span>Time survived: </span><span id="time">0</span>
                <span> | </span> 
                <span>Lives left: </span><span id="lives">0</span>
                <span> | </span>
                <span>Nukes left: </span><span id="nukes">0</span>
            </div>
            <div id="info_text">
                <span id="messages"></span>
            </div>
        </div>
        <div id="game_area">
            <button id="save_button">Save</button>
            <div id="warning"></div>
            <div id="healthpack" class="bonus"></div>
            <div id="ammopack" class="bonus"></div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>
        "use strict";
        
        //storing some commonly used variables:
        var button =  $("#save_button");
        var game_area = $("#game_area");
        var warning = $("#warning");
        var health_pack = $("#healthpack");
        var ammo_pack = $("#ammopack");
        var offset_h = game_area.offset().left;
        var offset_v = game_area.offset().top;
        var height = game_area.outerHeight();
        var width = game_area.outerWidth();
        var btn_h = button.outerHeight();
        var btn_w = button.outerWidth();
        
        //game variables, initialized by play_game()
        var pause;
        var time;
        var x;
        var y;
        var nukes;
        var hp;
        
        var max_hp = 100;
        var max_nukes = 5;
        
        //the game has max 200 obstacles
        var max_obstacles = 200;
        //we now create and append all of these in the DOM at once
        //later, we will just make them visible one at a time 
        //instead of creating and appending a new element every second
        var obstacle_count = 0; //number of visible obstacles
        var obstacles = new Array(max_obstacles);
        for (var i = 0; i < max_obstacles; i++) {
            var o = $('<div class="obstacle"></div>');
            o.hide();
            game_area.append(o);
            //add obstacle to array (we'll set the values later)
            obstacles[i] = {
                "o" : o,
                "speedX" : 0,
                "speedY" : 0,
                "x" : 0,
                "y" : 0,
                "active" : false
            };
        }
        
        //handles for intervals (periodic events) used by the game,
        //leave them undefined for now, play_game() sets them, game_over() clears them
        var mainloop;
        var obstacle_spawn;
        var timer;
        
        //global functions:
        
        function set_position(obj, x_pos, y_pos) {
            /*
            Moves obj to the percentage coordinates x_pos, y_pos.
            */
            obj.css('top',  (100 * y_pos) + '%');
            obj.css('left', (100 * x_pos) + '%');
        }
        function x_out_of_bounds(obj) {
            /*
            Returns true if obj is outside of the game area in x direction, otherwise returns false.
            */
            var xcoord = obj.offset().left;
            if (xcoord + obj.outerWidth() > offset_h + width) return true;
            if (xcoord < offset_h) return true;
            return false;
        }
        function y_out_of_bounds(obj) {
            /*
            Returns true if obj is outside of the game area in y direction, otherwise returns false.
            */
            var ycoord = obj.offset().top;
            if (ycoord + obj.outerHeight() > offset_v + height) return true;
            if (ycoord < offset_v) return true;
            return false;
        }
        function out_of_bounds(obj) {
            /*
            Returns true if obj is outside of the game area in any direction, otherwise returns false.
            */
            return x_out_of_bounds(obj) || y_out_of_bounds(obj);
        }
        function collide(obst) {
            /*
            Returns true if obst collides (overlaps) with button.
            */
            var l1 = obst.offset().left;
            var r1 = l1 + obst.outerWidth();
            var u1 = obst.offset().top;
            var d1 = u1 + obst.outerHeight();
            
            
            var l2 = button.offset().left;
            var r2 = l2 + btn_w;
            var u2 = button.offset().top;
            var d2 = u2 + btn_h;
            
            return !(
                (r1 < l2) || (l1 > r2)
                ||
                (u1 > d2) || (d1 < u2)
            );
        }
        function show_message(msg, time) {
            $("#messages").text(msg);
            window.setTimeout(function() {
                $("#messages").text(""); 
            }, time);
        }
        function nuke() {
            if (nukes) {
                obstacle_count = 0;
                $(".obstacle").hide();
                hp -= 15;
                $("#lives").text(hp);
                nukes--;
                $("#nukes").text(nukes);
                show_message("BOOM!", 1000);
                window.setTimeout(function() {
                    show_message("Uh-oh, the nuke damaged the save button...", 2000);
                }, 1500);
            }
        }
        function game_over(send_score) {
            /*
            Ends the current game and sends the score to the game service (via postMessage).
            */
            
            pause = true;
            
            //inform player:
            $("#messages").text("Game Over");
           
            //remove stuff:
            button.hide();
            warning.hide();
            obstacle_count = 0;
            $(".obstacle").hide();
            window.clearInterval(mainloop);
            window.clearInterval(obstacle_spawn);
            window.clearInterval(timer);
            
            //send highscore:
            if (send_score) {
                msg = {
                    "messageType": "LOAD_REQUEST",
                    "score" : time
                }
                window.parent.postMessage(msg, '*');
            }
        }
        function new_game() {
            game_over(false);
            button.show();
            warning.show();
            show_message("New game started", 2000);
            play_game();
        }
        function pause_game() {
            pause = !pause;
            if (pause) {
                $("#messages").text("Paused");
            }
            else {
                $("#messages").text("Resumed");
            }
        }
        function load_request() {
            var msg = {
                "messageType": "LOAD_REQUEST",
            };
            window.parent.postMessage(msg, "*");
        }
        function save_game() {
            y = button.offset().top / height;
            x = button.offset().left / width;
            var obstacles_data = [];
            for (var i = 0; i < obstacles.length; i++) {
                var obst = obstacles[i];
                if (obst.active) {
                    obstacles_data.push({
                        "speedX" : obst.speedX,
                        "speedY" : obst.speedY,
                        "x" : obst.x,
                        "y" : obst.y
                    });
                }
            }
            var msg = {
                "messageType" : "SAVE",
                "gameState" : {
                    "time" : time,
                    "obstacles" : obstacles_data,
                    "x" : x,
                    "y" : y,
                    "hp" : hp,
                    "nukes" : nukes
                }
            };
            window.parent.postMessage(msg, "*");
        }
        function load_game(data) {
            game_over(false);
            window.setTimeout(function() {
                button.show();
                warning.show();
                var gs = data.gameState;
                play_game(gs.x, gs.y, gs.obstacles, gs.time, gs.nukes, gs.hp);
            }, 1000);
        }
        
        function play_game(x_i, y_i, obst_i, time_i, nukes_i, hp_i) {
            /*
            Starts a new game, possibly with initial state (such as when loading a save).
            
            Args:
            x_i:     initial x coordinate 
            y_i:     initial y coordinate
            obst_i:  initial list of obstacles (each obstacle has coordinates and speed)
            
            In order for the game to work when it is loaded with a different screen size,
            coordinates are percentages (of total width and height).
            
            Returns:
            handles for the timers (so they can be cleared when game is over)
             */
            
            pause = false;
            
            health_pack.hide();
            ammo_pack.hide();
            
            //update in case screen size has changed
            offset_h = game_area.offset().left;
            offset_v = game_area.offset().top;
            height = game_area.outerHeight();
            width = game_area.outerWidth();
            btn_h = button.outerHeight();
            btn_w = button.outerWidth();
            
            //default (new game settings)
            obstacle_count = 0;
            nukes = max_nukes;
            hp = max_hp;
            time = 0;
            y = 0.5;
            x = 0.5;

            //overrides
            if (x_i !== undefined) 
                x = x_i;
            if (y_i !== undefined) 
                y = y_i;  
            if (obst_i !== undefined) {
                obstacle_count = obst_i.length;
                for (var i = 0; i < obstacle_count; i++) {
                    var obst = obstacles[i];
                    obst.speedX = obst_i[i].speedX;
                    obst.speedY = obst_i[i].speedY;
                    obst.x = obst_i[i].x;
                    obst.y = obst_i[i].y;
                    obst.active = true;
                    set_position(obst.o, obst.x, obst.y);
                    obst.o.show();
                }
            }
            if (time_i !== undefined) 
                time = time_i;
            if (nukes_i !== undefined)
                nukes = nukes_i;
            if (hp_i !== undefined)
                hp = hp_i;
                
            
            set_position(button, x, y);
            for (var i = 0; i < obstacles.length; i++) {
                var obst = obstacles[i];
                set_position(obst.o, obst.x, obst.y);
                game_area.append(obst.o);
            }
            $("#lives").text(hp);
            $("#nukes").text(nukes);
            
            //ok, start game:
            //game consists of periodic events, obstacles appearing and moving
            //store handles to these intervals so they can be cleared later
            
            timer = window.setInterval(function() {
                //increase counter by one every second
                if (!pause) {
                    time++;
                    $("#time").text(time);
                }
            }, 1000);
            
            obstacle_spawn = window.setInterval(function() {
                //every second, add new obstacle
                if (!pause && obstacle_count < max_obstacles) {
                    //add new obstacle at random position
                    var x_c = Math.random();
                    var y_c = Math.random();
                    var obst = obstacles[obstacle_count];
                    obst.speedX = 0.002 * Math.sqrt(time) * (Math.random() * 2 - 1);
                    obst.speedY = 0.002 * Math.sqrt(time) * (Math.random() * 2 - 1);
                    obst.x = x_c;
                    obst.y = y_c;
                    obst.active = true;
                    set_position(obst.o, x_c, y_c);
                    obstacle_count++;
                    
                    //draw spawn point warning
                    set_position(warning, x_c, y_c);
                    window.setTimeout(function() {
                        //wait 1 sec so player can see spawn point first, then add obstacle
                        set_position(obst.o, x_c, y_c);
                        obst.o.show();
                    }, 1000);
                }
                //sometimes, add health pack:
                var r = Math.random();
                if (r > 0.97) {
                    set_position(health_pack, Math.random(), Math.random());
                    health_pack.show();
                }
                //sometimes, add ammo pack:
                var r = Math.random();
                if (r > 0.95) {
                    set_position(ammo_pack, Math.random(), Math.random());
                    ammo_pack.show();
                }
                
            }, 1000);
            
            mainloop = window.setInterval(function() {
                //mainloop: move obstacles and detect collisions
                if (!pause) {
                    if (hp <= 0)
                        game_over();
                    for (var i = 0; i < obstacle_count; i++) {
                        var obst = obstacles[i];
                        if (collide(obst.o)) {
                            hp--;
                            $("#lives").text(hp);
                        }
                        var old_x = obst.x;
                        var old_y = obst.y;
                        obst.y += obst.speedY;
                        obst.x += obst.speedX;
                        var x_out = x_out_of_bounds(obst.o);
                        var y_out = y_out_of_bounds(obst.o);
                        if (!x_out && !y_out) {
                            set_position(obst.o, obst.x, obst.y);
                        }
                        else {
                            if (x_out)
                                obst.speedX = -obst.speedX;
                            if (y_out)
                                obst.speedY = -obst.speedY;   
                            obst.x = old_x += obst.speedX;
                            obst.y = old_y += obst.speedY;
                            set_position(obst.o, obst.x, obst.y);
                        }
                    }
                }
            }, 20);
            
        }
        $(document).ready(function() {  
            $("#newgame_button").click(function() {
                new_game();
            });          
            $("#load_button").click(function() {
                load_request();
            });       
            $("#pause_button").click(function() {
                pause_game();
            });       
            $(document).keydown(function(event) {
                if (event.which === 81)
                    load_request();
                else if (event.which === 87)
                    pause_game();
                else if (event.which === 69)
                    new_game();
                else if (event.which === 32 && !pause)
                    nuke();
            });
            
            button.click(function() {
                if (obstacles) 
                    save_game(); 
            });
            
            window.addEventListener("message", function(event) {
                if (event.data.messageType === "LOAD") {
                    load_game(event.data);
                } 
                else if (event.data.messageType === "MESSAGE") {
                    show_message(event.data.message, 2000);
                }
            });
            
            $(window).resize(function() {
                /*
                Make sure that objects stay at the same percentage coordinates in the resized window.
                */
                offset_h = game_area.offset().left;
                offset_v = game_area.offset().top;
                height = game_area.outerHeight();
                width = game_area.outerWidth();
                btn_h = button.outerHeight();
                btn_w = button.outerWidth();
                for (var i = 0; i < obstacle_count; i++) {
                    var obst = obstacles[i];
                    set_position(obst.o, obst.x, obst.y);
                }
            });
            
            game_area.mousemove(function(event) {
                /*
                Sets the save button to the current mouse position when mouse is moved.
                */
                if (!pause) {
                    var x_real = event.pageX - 0.5 * btn_w;
                    var y_real = event.pageY - 0.5 * btn_h;
                    if (x_real > offset_h && x_real + btn_w < width + offset_h && y_real + btn_h < height + offset_v && y_real > offset_v) {
                        button.offset({'top' : y_real, 'left' : x_real});
                    }
                    if (collide(health_pack)) {
                        hp += 5;
                        health_pack.hide();
                        $("#lives").text(hp);
                        show_message("Recovered 5 HP!", 2000);
                    }
                    if (collide(ammo_pack)) {
                        nukes++;
                        ammo_pack.hide();
                        $("#nukes").text(nukes);
                        show_message("Found more ammo!", 2000);
                    }
                }
            });
            play_game();
        });
        </script>
    </body>
</html>